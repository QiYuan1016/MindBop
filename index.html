<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MindGreen (Web)</title>
<style>
  :root{
    --green:#2e7d32; --blue:#1e3a8a; --mint:#eef9f7; --ink:#0f172a; --soft:#f7fafc;
    --gold:#fbbf24;
  }
  *{box-sizing:border-box;}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  #app{min-height:100dvh; background:linear-gradient(180deg,#f0fff4,#ebf8ff);}
  .screen{display:none; min-height:100dvh; padding:16px 16px 96px;}
  .screen.active{display:block;}
  .title{font-size:22px; font-weight:700; text-align:center; margin:8px 0 16px; color:var(--ink);}
  .btn{display:inline-flex; align-items:center; gap:10px; border:none; border-radius:14px; padding:14px 16px; font-size:16px; cursor:pointer; transition:transform .06s ease,opacity .15s ease; user-select:none;}
  .btn:active{transform:scale(.98); opacity:.9;}
  .btn.block{width:100%; justify-content:center;}
  .btn.green{background:#0a8f36; color:#fff;}
  .btn.blue{background:#0b4acb; color:#fff;}
  .btn.ghost{background:transparent; color:var(--ink);}
  .card-btn{display:flex; align-items:center; gap:12px; background:#ffffffdd; border:1px solid #e6eef7; border-radius:16px; padding:14px; margin:10px 0;}
  .card-btn img{width:64px; height:64px; object-fit:contain}
  .welcome{font-size:18px; text-align:center; color:#1f2937; margin:6px 0 2px;}
  .subtle{color:#475569; font-size:14px;}
  .spacer{height:12px;}
  .list{display:flex; flex-direction:column; gap:8px;}
  .row{display:flex; gap:10px; align-items:center; padding:10px; background:#fff; border:1px solid #e9eef3; border-radius:12px;}
  .row .grow{flex:1;}
  .badge{display:inline-block; padding:2px 8px; font-size:12px; background:#eef2ff; color:#3730a3; border-radius:999px;}
  .empty{padding:32px 12px; text-align:center; color:#6b7280; background:#fff; border:1px dashed #cbd5e1; border-radius:12px;}
  .input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #dbe3ec; font-size:16px;}
  /* bottom nav */
  .nav{position:fixed; left:0; right:0; bottom:0; height:78px; background:#ffffffee; backdrop-filter: blur(6px);
       border-top:1px solid #e5e7eb; display:grid; grid-template-columns:repeat(5,1fr); gap:6px; padding:8px 8px 10px;}
  .nav button{background:transparent; border:none; border-radius:12px; display:flex; align-items:center; justify-content:center; gap:8px; font-size:12px; color:#0f172a;}
  .nav button img{width:28px; height:28px; object-fit:contain;}
  .nav button.active{background:#f1f5f9;}
  /* decoration area */
  .palette{display:flex; gap:10px; padding:8px; overflow:auto;}
  .palette .tile{min-width:64px; min-height:64px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; display:flex; align-items:center; justify-content:center; padding:6px; cursor:pointer;}
  .playground-wrap{position:relative; height:52vh; background:var(--mint); border:1px solid #d1fae5; border-radius:16px; overflow:hidden;}
  .playground{position:absolute; inset:0;}
  .placed{position:absolute; width:80px; height:80px; touch-action:none; user-select:none; cursor:grab;}
  .hint{font-size:12px; color:#475569; text-align:center; margin-top:6px;}
  /* stars */
  .stars{font-size:18px; color:var(--gold);}
  /* responsive */
  @media (min-width:900px){
    .screen{max-width:860px; margin:0 auto;}
  }
</style>
</head>
<body>
<div id="app">
  <!-- Loading -->
  <section id="loading" class="screen active" aria-label="Loading">
    <div style="display:flex; align-items:center; justify-content:center; flex-direction:column; height:70vh; gap:18px;">
      <img id="logo" alt="logo" style="width:240px; max-width:60%; display:none;">
      <div id="logoFallback" style="font-size:40px; font-weight:800; color:#065f46;">MindGreen</div>
      <button id="startBtn" class="btn green block" style="max-width:360px;">Start</button>
      <div class="subtle">Let‚Äôs grow good habits üå±</div>
      <audio id="bgm" loop src="background_music.mp3"></audio>
    </div>
  </section>

  <!-- Name -->
  <section id="name" class="screen" aria-label="Enter Name">
    <div class="title">Welcome to MindGreen</div>
    <p class="subtle" style="text-align:center;margin-bottom:14px;">Please enter your name:</p>
    <input id="nameInput" class="input" placeholder="Your name" />
    <div class="spacer"></div>
    <button class="btn green block" id="saveName">Save & Continue</button>
  </section>

  <!-- Main -->
  <section id="main" class="screen" aria-label="Main Menu">
    <div class="welcome" id="welcomeText">Welcome!</div>
    <div class="subtle" style="text-align:center;">Choose a challenge type</div>
    <div class="card-btn" id="btnNature">
      <img id="imgNature" alt="nature">
      <div>
        <div style="font-weight:700;">Nature Challenge</div>
        <div class="subtle">Explore and enjoy the outdoors</div>
      </div>
    </div>
    <div class="card-btn" id="btnRecycle">
      <img id="imgRecycle" alt="recycle">
      <div>
        <div style="font-weight:700;">Recycle Challenge</div>
        <div class="subtle">Reduce waste, recycle smart</div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="nav" role="navigation">
      <button data-go="main" class="active"><img alt="" id="icHome"><span>Home</span></button>
      <button data-go="progress"><img alt="" id="icProg"><span>Progress</span></button>
      <button data-go="achievement"><img alt="" id="icAchv"><span>Achievement</span></button>
      <button data-go="shop"><img alt="" id="icShop"><span>Shop</span></button>
      <button data-go="decoration"><img alt="" id="icDeco"><span>Decor</span></button>
    </div>
  </section>

  <!-- Type -->
  <section id="type" class="screen" aria-label="Choose Method">
    <div class="title" id="typeTitle">Challenges</div>
    <button id="randomBtn" class="btn green block">üé≤ Random Challenge</button>
    <div class="spacer"></div>
    <button id="chooseBtn" class="btn blue block">üìú Choose Challenge</button>
    <div class="spacer"></div>
    <div class="nav"></div>
  </section>

  <!-- Challenge List -->
  <section id="challenge_list" class="screen" aria-label="Challenge List">
    <div class="title" id="listTitle">Choose a Challenge</div>
    <div id="challengeList" class="list"></div>
    <div class="spacer"></div>
    <div class="nav"></div>
  </section>

  <!-- Progress -->
  <section id="progress" class="screen" aria-label="Progress">
    <div class="title" style="display:flex; gap:10px; align-items:center; justify-content:center;">
      <img id="icInProgress" alt="" style="width:48px;height:48px;display:none;">
      <span>Your Tasks</span>
      <span id="ipFallback" style="font-size:32px; display:none;">‚è≥</span>
    </div>
    <div id="tasksWrap"></div>
    <div class="nav"></div>
  </section>

  <!-- Achievement -->
  <section id="achievement" class="screen" aria-label="Achievement">
    <div class="title">Achievements</div>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button class="btn ghost" id="btnCatNature">üåø Nature</button>
      <button class="btn ghost" id="btnCatRecycle">‚ôªÔ∏è Recycle</button>
    </div>
    <div id="achvList" class="list"></div>
    <div class="nav"></div>
  </section>

  <!-- Shop -->
  <section id="shop" class="screen" aria-label="Shop">
    <div class="title" id="shopTitle">Shop ‚Äî Points: 0</div>
    <div id="shopList" class="list"></div>
    <div class="nav"></div>
  </section>

  <!-- Decoration -->
  <section id="decoration" class="screen" aria-label="Decoration">
    <div class="title">Decoration</div>
    <div class="palette" id="palette"></div>
    <div class="playground-wrap">
      <div class="playground" id="playground"></div>
    </div>
    <div class="hint">Tip: Click a palette item, then clickÂú®ËçâÂú∞‰∏äÊîæÁΩÆ„ÄÇÊãñÂä®ÂèØÁßªÂä®ÔºåÊªöËΩÆÂèØÁº©ÊîæÔºå‰ΩçÁΩÆ‰ºöËá™Âä®‰øùÂ≠ò„ÄÇ</div>
    <div class="nav"></div>
  </section>
</div>

<script>
/* -------------------------
   Assets (optional)
-------------------------- */
const IMG = {
  logo: "mindgreen_logo.png",
  plant: "plant.png",
  recycle: "recycle.png",
  in_progress: "in_progress.png",
  nav_home: "icons/home.png",
  nav_progress: "icons/progress.png",
  nav_achievement: "icons/achievement.png",
  nav_shop: "icons/shop.png",
  nav_deco: "icons/decoration.png",

  decor_flower: "decor_flower.png",
  decor_bird: "decor_bird.png",
  decor_butterfly: "decor_butterfly.png",
  decor_stone: "decor_stone.png",
  decor_tree: "decor_tree.png",
  decor_playground: "decor_playground.png",
  decor_house: "decor_house.png",
  decor_car: "decor_car.png",
  decor_rabbit: "decor_rabbit.png",
};

/* -------------------------
   Data store (localStorage)
-------------------------- */
const DEFAULTS = {
  profile: { name: "", points: 0 },
  progress: { tasks: [] }, // {text, started}
  achievements: { nature:{}, recycle:{} }, // taskName: times
  decorations: { items: [] }, // owned shop items
  placed: { items: [] }, // {name, icon, x,y, scale}
};
function load(key){
  try{ return JSON.parse(localStorage.getItem("MG_"+key)) ?? structuredClone(DEFAULTS[key]); }
  catch(e){ return structuredClone(DEFAULTS[key]); }
}
function save(key, val){
  localStorage.setItem("MG_"+key, JSON.stringify(val));
}
function ensureAll(){
  for(const k of Object.keys(DEFAULTS)){
    if(localStorage.getItem("MG_"+k)===null) save(k, DEFAULTS[k]);
  }
}
ensureAll();

/* -------------------------
   Challenge data
-------------------------- */
const recycle_challenges = [
  "Use a reusable water bottle",
  "Bring your own shopping bag",
  "Buy products with paper or glass packaging",
  "Say 'No' to plastic cutlery",
  "Turn an old T-shirt into a shopping bag",
  "Collect old batteries and bring to e-waste recycling",
  "Plastic Bottle Challenge - Collect and recycle 2-3 plastic bottles today",
  "Recycle Art Challenge - Create an art piece or craft using only recyclable materials",
  "Donate old clothes you no longer wear",
  "Avoid using single-use straws for a week",
  "Recycle all old newspapers and magazines at home",
  "Recycle all aluminium cans from drinks you and your family consume today"
];
const nature_challenges = [
  "Watch the sunrise and take a photo",
  "Record 2 minutes of nature sounds",
  "Identify 3 different tree species and take photos",
  "Spend 1 hour outside without devices",
  "Plant a seed and take a photo of it"
];

/* -------------------------
   Shop catalog
-------------------------- */
const CATALOG = {
  "Flower Pot": { cost: 15, icon: IMG.decor_flower },
  "Bird House": { cost: 25, icon: IMG.decor_bird },
  "Butterfly":  { cost: 20, icon: IMG.decor_butterfly },
  "Stone Path": { cost: 10, icon: IMG.decor_stone },
  "Tree":       { cost: 30, icon: IMG.decor_tree },
  "Playground": { cost: 50, icon: IMG.decor_playground },
  "House":      { cost: 15, icon: IMG.decor_house },
  "Car":        { cost: 10, icon: IMG.decor_car },
  "Rabbit":     { cost: 15, icon: IMG.decor_rabbit }
};

/* -------------------------
   Helpers
-------------------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];

function show(screenId){
  $$(".screen").forEach(s => s.classList.remove("active"));
  $("#"+screenId).classList.add("active");
  // È´ò‰∫ÆÂ∫ïÈÉ®ÂØºËà™
  $$(".nav button").forEach(b=>{
    if(b.dataset.go){
      b.classList.toggle("active", b.dataset.go===screenId);
    }
  });
  if(screenId==="main") renderMain();
  if(screenId==="type") renderType();
  if(screenId==="challenge_list") renderChallengeList();
  if(screenId==="progress") renderProgress();
  if(screenId==="achievement") renderAchievement(currentCategory);
  if(screenId==="shop") renderShop();
  if(screenId==="decoration") renderDecoration();
}

// ÂõæÁâáÂ≠òÂú®Ê£ÄÊµãÔºàÂ§±Ë¥•ÂàôÁî® emojiÔºâ
function setImgOrEmoji(imgEl, path, emoji="üñº"){
  imgEl.style.display = "none";
  const test = new Image();
  test.onload = ()=>{ imgEl.src = path; imgEl.style.display="block"; };
  test.onerror = ()=>{ imgEl.replaceWith(Object.assign(document.createElement("div"), {textContent:emoji, style:"font-size:40px;"})); };
  test.src = path;
}

function isoNow(){ return new Date().toISOString(); }

/* -------------------------
   Loading / audio
-------------------------- */
setImgOrEmoji($("#logo"), IMG.logo, "üåø");
$("#logo").style.display="block";
$("#logoFallback").style.display="none"; // Â¶ÇÊûúÂ§±Ë¥•Ôºå‰∏äÈù¢ÁöÑÂáΩÊï∞‰ºöÊõøÊç¢; Ëã•ÊàêÂäüÂ∞±ÊòæÁ§∫ logo
// Start button
$("#startBtn").addEventListener("click", ()=>{
  const bgm = $("#bgm");
  // Â∞ùËØïÊí≠ÊîæÔºàÊúâÁî®Êà∑ÁÇπÂáªÔºåÊµèËßàÂô®ÂÖÅËÆ∏Ôºâ
  bgm.play().catch(()=>{ /* ÂøΩÁï•Â§±Ë¥• */ });
  const profile = load("profile");
  if(!profile.name){ show("name"); }
  else{ show("main"); }
});

/* -------------------------
   Name screen
-------------------------- */
$("#saveName").addEventListener("click", ()=>{
  const name = ($("#nameInput").value||"").trim();
  if(!name){ alert("Please enter your name."); return; }
  const profile = load("profile");
  profile.name = name;
  save("profile", profile);
  show("main");
});

/* -------------------------
   Main screen
-------------------------- */
function renderMain(){
  const profile = load("profile");
  $("#welcomeText").textContent = `Welcome, ${profile.name||"Player"}!`;
  setImgOrEmoji($("#imgNature"), IMG.plant, "üåø");
  setImgOrEmoji($("#imgRecycle"), IMG.recycle, "‚ôªÔ∏è");

  // Â∫ïÈÉ®ÂõæÊ†á
  setImgOrEmoji($("#icHome"), IMG.nav_home, "üè†");
  setImgOrEmoji($("#icProg"), IMG.nav_progress, "üìà");
  setImgOrEmoji($("#icAchv"), IMG.nav_achievement, "üèÜ");
  setImgOrEmoji($("#icShop"), IMG.nav_shop, "üõí");
  setImgOrEmoji($("#icDeco"), IMG.nav_deco, "üé®");
}
$("#btnNature").addEventListener("click", ()=>{ currentType="nature"; show("type"); });
$("#btnRecycle").addEventListener("click", ()=>{ currentType="recycle"; show("type"); });

/* -------------------------
   Nav (works for all screens)
-------------------------- */
function wireNav(container){
  container.querySelectorAll("button[data-go]").forEach(btn=>{
    btn.addEventListener("click", ()=> show(btn.dataset.go));
  });
}
$$(".nav").forEach(wireNav);

/* -------------------------
   Type screen
-------------------------- */
let currentType = "nature";
function renderType(){
  $("#typeTitle").textContent = (currentType==="nature"?"Nature":"Recycle")+" Challenges";
}
$("#randomBtn").addEventListener("click", ()=>{
  const list = currentType==="nature"? nature_challenges : recycle_challenges;
  const ch = list[Math.floor(Math.random()*list.length)];
  const progress = load("progress");
  progress.tasks.push({ text: ch, started: isoNow() });
  save("progress", progress);
  show("progress");
});
$("#chooseBtn").addEventListener("click", ()=> show("challenge_list"));

/* -------------------------
   Challenge list screen
-------------------------- */
function renderChallengeList(){
  $("#listTitle").textContent = `Choose a ${currentType==="nature"?"Nature":"Recycle"} Challenge`;
  const wrap = $("#challengeList");
  wrap.innerHTML = "";
  const list = currentType==="nature"? nature_challenges : recycle_challenges;
  list.forEach(text=>{
    const row = document.createElement("div");
    row.className="row";
    row.innerHTML = `<div class="grow">${text}</div>
      <button class="btn blue">Select</button>`;
    row.querySelector("button").addEventListener("click", ()=>{
      const progress = load("progress");
      progress.tasks.push({ text, started: isoNow() });
      save("progress", progress);
      show("progress");
    });
    wrap.appendChild(row);
  });
}

/* -------------------------
   Progress screen
-------------------------- */
function renderProgress(){
  // icon
  const icon = $("#icInProgress");
  const fallback = $("#ipFallback");
  const timg = new Image();
  timg.onload = ()=>{ icon.src = IMG.in_progress; icon.style.display="inline-block"; fallback.style.display="none"; };
  timg.onerror = ()=>{ icon.style.display="none"; fallback.style.display="inline-block"; };
  timg.src = IMG.in_progress;

  const tasksWrap = $("#tasksWrap");
  tasksWrap.innerHTML = "";
  const {tasks} = load("progress");
  if(!tasks.length){
    tasksWrap.innerHTML = `<div class="empty">No tasks yet. Choose a challenge!</div>`;
    return;
  }
  const list = document.createElement("div"); list.className="list";
  tasks.forEach((t, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    const started = new Date(t.started);
    row.innerHTML = `
      <div class="grow">
        <div style="font-weight:600;">${t.text}</div>
        <div class="subtle">Started: ${started.toLocaleString()}</div>
      </div>
      <button class="btn green">Finish</button>
    `;
    row.querySelector("button").addEventListener("click", ()=>{
      finishTask(t);
    });
    list.appendChild(row);
  });
  tasksWrap.appendChild(list);
}

function finishTask(task){
  // remove from progress
  const progress = load("progress");
  const i = progress.tasks.findIndex(tt => tt.text===task.text && tt.started===task.started);
  if(i>-1) progress.tasks.splice(i,1);
  save("progress", progress);

  // +10 points
  const profile = load("profile");
  profile.points = (profile.points||0) + 10;
  save("profile", profile);

  // achievements increment
  const achv = load("achievements");
  const isNature = nature_challenges.includes(task.text);
  const cat = isNature ? "nature" : "recycle";
  const catDict = achv[cat] || {};
  catDict[task.text] = (catDict[task.text]||0) + 1;
  achv[cat] = catDict;
  save("achievements", achv);

  alert(`Well done! You earned 10 points.\nTotal: ${profile.points}`);
  renderProgress();
}

/* -------------------------
   Achievement screen
-------------------------- */
let currentCategory = "nature";
$("#btnCatNature").addEventListener("click", ()=>{ currentCategory="nature"; renderAchievement(currentCategory); });
$("#btnCatRecycle").addEventListener("click", ()=>{ currentCategory="recycle"; renderAchievement(currentCategory); });

function starsForTimes(times){
  if(times>=100) return "‚≠ê‚≠ê‚≠ê";
  if(times>=50)  return "‚≠ê‚≠ê";
  if(times>=10)  return "‚≠ê";
  return "No star";
}
function renderAchievement(category="nature"){
  const list = $("#achvList");
  list.innerHTML = "";
  const achv = load("achievements")[category] || {};
  const entries = Object.entries(achv);
  if(!entries.length){
    list.innerHTML = `<div class="empty">No achievements yet</div>`;
    return;
  }
  entries.forEach(([taskName, rawTimes])=>{
    const times = typeof rawTimes==="object" ? (rawTimes.times||0) : Number(rawTimes||0);
    const row = document.createElement("div");
    row.className="row";
    row.innerHTML = `
      <div class="grow">${taskName}</div>
      <div class="badge">${times} times</div>
      <div class="stars">${starsForTimes(times)}</div>
    `;
    list.appendChild(row);
  });
}

/* -------------------------
   Shop screen
-------------------------- */
function renderShop(){
  const profile = load("profile");
  $("#shopTitle").textContent = `Shop ‚Äî Points: ${profile.points||0}`;
  const wrap = $("#shopList");
  wrap.innerHTML = "";
  for(const [name, info] of Object.entries(CATALOG)){
    const row = document.createElement("div");
    row.className="row";
    const icon = document.createElement("img");
    icon.style.width="64px"; icon.style.height="64px"; icon.style.objectFit="contain";
    setImgOrEmoji(icon, info.icon, "üñº");
    const buyBtn = document.createElement("button");
    buyBtn.className="btn blue"; buyBtn.textContent="Buy";
    buyBtn.addEventListener("click", ()=> buyItem(name));
    const text = document.createElement("div");
    text.className="grow";
    text.innerHTML = `<div style="font-weight:600;">${name}</div><div class="subtle">Cost: ${info.cost} pts</div>`;
    row.append(icon, text, buyBtn);
    wrap.appendChild(row);
  }
}
function buyItem(name){
  const profile = load("profile");
  const cost = CATALOG[name].cost;
  if((profile.points||0) < cost){ alert("Not enough points"); return; }
  profile.points -= cost; save("profile", profile);
  const deco = load("decorations");
  // ÂÖÅËÆ∏ÈáçÂ§çË¥≠‰π∞ÂêóÔºüKivyÁâàÈôêÂà∂ÈáçÂ§ç‚ÄúÊîæÁΩÆ‚ÄùÂêåÂêçÔºå‰∏çÈôêÂà∂Ë¥≠‰π∞ÔºõËøôÈáå‰øùÊåÅ‰∏ÄËá¥ÔºöÂèØ‰π∞Â§öÊ¨°Ôºå‰ΩÜÊîæÁΩÆÊó∂ÈôêÂà∂‰∏Ä‰∏™ÂêåÂêç
  deco.items.push({ name, icon: CATALOG[name].icon });
  save("decorations", deco);
  alert(`Purchased ${name}`);
  renderShop();
}

/* -------------------------
   Decoration screen
-------------------------- */
let placeCandidate = null; // {name,icon}
function renderDecoration(){
  // palette
  const pal = $("#palette"); pal.innerHTML="";
  const owned = load("decorations").items || [];
  if(!owned.length){
    pal.innerHTML = `<div class="empty" style="width:100%;">No decorations yet. Go to Shop üõí</div>`;
  }else{
    owned.forEach(item=>{
      const tile = document.createElement("div");
      tile.className="tile"; tile.title = `Place ${item.name}`;
      const img = document.createElement("img"); img.style.width="48px"; img.style.height="48px"; img.alt=item.name;
      setImgOrEmoji(img, item.icon, "üéÅ");
      tile.appendChild(img);
      tile.addEventListener("click", ()=>{ placeCandidate = item; alert("Tap on the grass to place this item.\nÂú®ËçâÂú∞‰∏äÁÇπ‰∏Ä‰∏ãÂ∞±‰ºöÊîæÁΩÆ„ÄÇ"); });
      pal.appendChild(tile);
    });
  }

  // playground
  const pg = $("#playground"); pg.innerHTML="";
  const placed = load("placed").items || [];
  placed.forEach(p=> addPlacedElement(pg, p));
}
function addPlacedElement(pg, obj){
  const el = document.createElement("img");
  el.className = "placed";
  el.alt = obj.name;
  setImgOrEmoji(el, obj.icon, "üé®");
  // position & scale
  el.style.left = (obj.x||50) + "px";
  el.style.top  = (obj.y||50) + "px";
  el.style.transform = `scale(${obj.scale||1})`;
  // Drag
  let dragging=false, sx=0, sy=0, startLeft=0, startTop=0;
  el.addEventListener("pointerdown", (ev)=>{
    dragging=true; el.setPointerCapture(ev.pointerId);
    sx = ev.clientX; sy = ev.clientY;
    startLeft = parseFloat(el.style.left); startTop = parseFloat(el.style.top);
    el.style.cursor="grabbing";
  });
  el.addEventListener("pointermove", (ev)=>{
    if(!dragging) return;
    const dx = ev.clientX - sx, dy = ev.clientY - sy;
    el.style.left = (startLeft + dx) + "px";
    el.style.top  = (startTop  + dy) + "px";
    // save continuously
    obj.x = startLeft + dx; obj.y = startTop + dy; persistPlaced();
  });
  el.addEventListener("pointerup", (ev)=>{
    dragging=false; el.releasePointerCapture(ev.pointerId);
    el.style.cursor="grab";
    persistPlaced();
  });
  // Wheel scale
  el.addEventListener("wheel", (ev)=>{
    ev.preventDefault();
    const cur = obj.scale || 1;
    const next = Math.max(0.4, Math.min(3, cur + (ev.deltaY<0? 0.1:-0.1)));
    obj.scale = next;
    el.style.transform = `scale(${next})`;
    persistPlaced();
  }, {passive:false});
  pg.appendChild(el);
}
function persistPlaced(){
  const placed = load("placed");
  save("placed", placed);
}
// Click to place
$("#playground").addEventListener("click", (ev)=>{
  if(!placeCandidate) return;
  // ‰∏çÂÖÅËÆ∏ÈáçÂ§çÊîæÁΩÆÂêåÂêçË£ÖÈ•∞ÂìÅ
  const placed = load("placed");
  if(placed.items.some(o=>o.name===placeCandidate.name)){
    placeCandidate=null; return;
  }
  // ÁÇπÂáª‰ΩçÁΩÆÁõ∏ÂØπ playground
  const rect = ev.currentTarget.getBoundingClientRect();
  const nx = ev.clientX - rect.left - 40;
  const ny = ev.clientY - rect.top  - 40;
  const obj = { name: placeCandidate.name, icon: placeCandidate.icon, x:nx, y:ny, scale:1 };
  placed.items.push(obj); save("placed", placed);
  addPlacedElement(ev.currentTarget, obj);
  placeCandidate = null;
});

/* -------------------------
   Bottom nav wiring for cloned navs
-------------------------- */
function cloneNavs(){
  $$("#main .nav")[0] // already wired
  const navHtml = $$("#main .nav")[0].outerHTML;
  ["#type .nav","#challenge_list .nav","#progress .nav","#achievement .nav","#shop .nav","#decoration .nav"].forEach(sel=>{
    const host = $(sel); host.outerHTML = navHtml; // clone structure
  });
  // re-wire after clone
  $$(".nav").forEach(wireNav);
}
cloneNavs();

/* -------------------------
   Fake initial achievements if empty (like your App.build)
-------------------------- */
(function seedDemo(){
  const ach = load("achievements");
  if(Object.keys(ach.nature||{}).length===0 && Object.keys(ach.recycle||{}).length===0){
    ach.nature = { "Tree Planting":12, "Watering":5 };
    ach.recycle = { "Plastic Bottles":20, "Paper Recycling":8 };
    save("achievements", ach);
  }
})();

/* -------------------------
   Main images load
-------------------------- */
setImgOrEmoji($("#imgNature"), IMG.plant, "üåø");
setImgOrEmoji($("#imgRecycle"), IMG.recycle, "‚ôªÔ∏è");
</script>
</body>
</html>
